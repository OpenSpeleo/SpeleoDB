#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset

python manage.py migrate

# Install npm dependencies and ensure correct esbuild binary for container architecture
rm -rf /app/tailwind_css/static_src/node_modules/@esbuild /app/tailwind_css/static_src/node_modules/esbuild
npm install --prefix /app/tailwind_css/static_src

# Start Tailwind + esbuild watchers in background
npm run --prefix /app/tailwind_css/static_src dev &

# Forward SIGTERM/SIGINT to children
trap "kill 0" SIGINT SIGTERM

# Run Django dev server (foreground, PID 1)
exec python manage.py runserver_plus 0000:8000
