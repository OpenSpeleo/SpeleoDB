{% extends "pages/project/base.html" %}
{% load static i18n compress %}

{% load filter_utils %}

{% block right_panel %}
<div class="grow">
    <div class="p-6 space-y-6">

        <div class="flex min-h-screen flex-col">
            <main class="flex flex-1 flex-col">

               <div class="container relative flex flex-col md:grid md:space-y-0 w-full md:grid-cols-12  space-y-4 md:gap-6 mb-16">
                  <section class="pt-8 border-gray-100 col-span-full">
                     <header class="flex flex-wrap items-center justify-start pb-2 md:justify-end lg:flex-nowrap">

                       <div class="mb-2 mr-2 flex w-full items-center md:w-auto">
                           <a class="btn git_btn group mr-0 flex-grow-0 cursor-pointer rounded-full text-sm md:px-4 md:text-base" href="{% url 'api:v1:download_project_at_hash' id=project.id hexsha=commit.hexsha fileformat='dump' %}">
                              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-file-type-zip mr-2" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"  width="1.5em" height="1.5em" viewBox="4.25 2.25 15.5 19.5">
                                 <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                 <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                                 <path d="M5 12v-7a2 2 0 0 1 2 -2h7l5 5v4"></path>
                                 <path d="M16 18h1.5a1.5 1.5 0 0 0 0 -3h-1.5v6"></path>
                                 <path d="M12 15v6"></path>
                                 <path d="M5 15h3l-3 6h3"></path>
                               </svg>
                              <span class="mr-1 text-gray-600">Download as ZIP</span>
                           </a>
                       </div>

                       <div class="mb-2 mr-2 flex w-full items-center md:w-auto">
                           <a class="btn git_btn group mr-0 flex-grow-0 cursor-pointer rounded-full text-sm md:px-4 md:text-base" href="{% url 'private:project_revisions' project_id=project.id %}">
                              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-history mr-2" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"  width="1.5em" height="1.5em" viewBox="2.3 2.16 19.45 19.5">
                                 <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                 <path d="M12 8l0 4l2 2"></path>
                                 <path d="M3.05 11a9 9 0 1 1 .5 4m-.5 5v-5h5"></path>
                               </svg>
                              <span class="mr-1 text-gray-600">History: {{n_commits}} commits</span>
                           </a>
                       </div>

                     </header>

                     <div class=" contents mt-4">
                        <div class="grid grid-cols-12 from-gray-100-to-white flex items-baseline rounded-t-lg border border-b-0 bg-gradient-to-t px-3 py-2 border-gray-600">
                           <div class="sm:col-span-12 md:col-span-9 flex flex-none items-center truncate text-gray-300">
                              {{ commit.author }}:<span class="ml-4 text-sm text-gray-400 truncate">{{ commit.message }}</span>
                           </div>
                           <div class="md:col-span-3 hidden md:flex items-center truncate ml-auto text-sm text-gray-300">
                              <span class="mr-1">{{ commit.hexsha_short }}</span> - {{ commit.date|time_struct_since }}
                           </div>
                        </div>

                        <ul id="git-viewer-container" class="mb-8 rounded-b-lg border border-t-0 border-gray-600 bg-gray-900/50">

                           <!-- FOLDER TEMPLATE -->

                           <li id="row-template-folder" class="grid h-10 grid-cols-12 place-content-center gap-x-3 border-t px-3 border-gray-600" style="display: none">
                              <div class="sm:col-span-8 md:col-span-3 flex items-center">
                                 <a class="group flex items-center truncate hover:underline" download="" href="#">

                                    <svg class="flex-none mr-2 text-gray-300 fill-current" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" role="img" width="1em" height="1em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 16 16">
                                       <path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path>
                                    </svg>
                                    <span class="truncate">images</span>

                                 </a>
                              </div>

                              <div class="group sm:col-span-4 md:col-span-2"></div>

                              <a class="md:col-span-5 hidden md:flex items-center font-mono text-sm text-gray-400 hover:underline" href="#">
                                 <span class="truncate">This is my first commit message</span>
                              </a>

                              <a class="md:col-span-2 hidden md:flex truncate ml-auto text-sm text-gray-400 items-center hover:underline" href="/private/project/b789c859-9593-4292-b8fb-2ee6f9ace220/browser/17ccac71c15923b5233879fe6ed5bb8c5adde057/">
                                 2 weeks ago
                              </a>
                           </li>

                           <!-- FILE TEMPLATE -->

                           <li id="row-template-file" class="grid h-10 grid-cols-12 place-content-center gap-x-3 border-t px-3 border-gray-600" style="display: none">
                              <div class="sm:col-span-8 md:col-span-3 flex items-center">
                                 <a class="download-file-link group flex items-center truncate hover:underline" download="" href="#">

                                    <svg class="flex-none mr-2 text-gray-300 fill-current" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" role="img" width="1em" height="1em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 16 16">
                                       <path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path>
                                    </svg>
                                    <span class="download-file-name truncate"></span>
                                 </a>
                              </div>
                              <a class="file-size-link group sm:col-span-4 md:col-span-2 flex items-center justify-self-end truncate text-right font-mono text-[0.8rem] leading-6 text-gray-400 xl:pr-10 hover:underline" title="Download file" download="" href="#">
                                 <span class="file-size"></span>
                                 <div class="ml-2 flex h-5 w-5 items-center justify-center rounded border text-gray-500 border-gray-600 xl:ml-4">
                                    <svg class="" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" role="img" width="1em" height="1em" viewBox="0 0 32 32">
                                       <path fill="currentColor" d="M26 24v4H6v-4H4v4a2 2 0 0 0 2 2h20a2 2 0 0 0 2-2v-4zm0-10l-1.41-1.41L17 20.17V2h-2v18.17l-7.59-7.58L6 14l10 10l10-10z"></path>
                                    </svg>
                                 </div>
                              </a>
                              <a class="commit-message md:col-span-5 hidden md:flex items-center font-mono text-sm text-gray-400 hover:underline truncate" href="#"></a>
                              <a class="commit-time-ago md:col-span-2 hidden md:flex truncate ml-auto text-sm text-gray-400 items-center hover:underline" href="#"></a>
                           </li>

                        </ul>
                     </div>
                  </section>
               </div>
            </main>
         </div>

    </div>
</div>

<div id="loading_spinner" class="loading" style="display:none;"></div>
{% endblock right_panel %}


{% block inline_extra_js %}
<script>
$( document ).ready(function() {

    $("#loading_spinner").show();

    $.ajax({
        url : "{% url 'api:v1:one_project_gitexplorer_apiview' id=project.id hexsha=commit.hexsha %}",
        type : "GET",
        dataType : "json",
        success: function(data){
            $("#loading_spinner").hide();

            if (data.success && data.data.files) {

               // Iterate over each commit and append a new row to the table
               data.data.files.forEach(function (file) {
                  console.log("file: " + file.name);
                  var $file_row = $('#row-template-file').clone();

                  // Remove the "ID" (to prevent deletion/cleanup) and make it unique
                  $file_row.removeAttr('id');

                  // Remove the "hidden" style (make it visible)
                  $file_row.removeAttr('style');
                  
                  // File Related Content
                  $file_row.find(".download-file-link").attr("href", file.download_url);
                  $file_row.find(".download-file-name").text(file.name);
                  $file_row.find(".file-size-link").attr("href", file.download_url);
                  $file_row.find(".file-size").text(file.size);

                  // Commit Related Content
                  $file_row.find(".commit-message").attr("href", file.commit.url).text(file.commit.message);
                  $file_row.find(".commit-time-ago").attr("href", file.commit.url).text(file.commit.dt_since);
                  
                  

                  // FINALLY: Append the populated row to the table body
                  // ---------------------------------------------------------------------
                  $('#git-viewer-container').append($file_row);
               });
            
            }
            else {
                console.log("ERROR: " + data.error);
            }
        },
        error: function (textStatus, errorThrown) {
            $("#loading_spinner").hide();
            console.log("ERROR: " + data.textStatus + " & " + errorThrown);
        }
    });
});
</script>
{% endblock inline_extra_js %}
