{% extends "pages/project/base.html" %}
{% load static i18n compress %}

{% load filter_utils %}

{% block right_panel %}
<div class="grow">
    <div class="p-6 space-y-6">

        <div class="flex min-h-screen flex-col">
            <main class="flex flex-1 flex-col">

               <div class="container relative flex flex-col md:grid md:space-y-0 w-full md:grid-cols-12  space-y-4 md:gap-6 mb-16">
                  <section class="pt-8 border-gray-100 col-span-full">
                     <header class="flex flex-wrap items-center justify-start pb-2 md:justify-end lg:flex-nowrap">

                       <div class="mb-2 mr-2 flex w-full items-center md:w-auto">
                           <a class="btn git_btn group mr-0 flex-grow-0 cursor-pointer rounded-full text-sm md:px-4 md:text-base" href="{% url 'api:v1:download_project_at_hash' id=project.id hexsha=commit.hexsha fileformat='dump' %}">
                              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-file-type-zip mr-2" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"  width="1.5em" height="1.5em" viewBox="4.25 2.25 15.5 19.5">
                                 <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                 <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                                 <path d="M5 12v-7a2 2 0 0 1 2 -2h7l5 5v4"></path>
                                 <path d="M16 18h1.5a1.5 1.5 0 0 0 0 -3h-1.5v6"></path>
                                 <path d="M12 15v6"></path>
                                 <path d="M5 15h3l-3 6h3"></path>
                               </svg>
                              <span class="mr-1 text-gray-600">Download as ZIP</span>
                           </a>
                       </div>

                       <div class="mb-2 mr-2 flex w-full items-center md:w-auto">
                           <a class="btn git_btn group mr-0 flex-grow-0 cursor-pointer rounded-full text-sm md:px-4 md:text-base" href="{% url 'private:project_revisions' project_id=project.id %}">
                              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-history mr-2" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"  width="1.5em" height="1.5em" viewBox="2.3 2.16 19.45 19.5">
                                 <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                 <path d="M12 8l0 4l2 2"></path>
                                 <path d="M3.05 11a9 9 0 1 1 .5 4m-.5 5v-5h5"></path>
                               </svg>
                              <span class="mr-1 text-gray-600">History: {{n_commits}} commits</span>
                           </a>
                       </div>

                     </header>

                     <div class=" contents mt-4">
                        <div class="grid grid-cols-12 from-gray-100-to-white flex items-baseline rounded-t-lg border border-b-0 bg-gradient-to-t px-3 py-2 border-gray-600">
                           <div class="sm:col-span-12 md:col-span-9 flex flex-none items-center truncate text-gray-300">
                              {{ commit.author }}:<span class="ml-4 text-sm text-gray-400 truncate">{{ commit.message }}</span>
                           </div>
                           <div class="md:col-span-3 hidden md:flex items-center truncate ml-auto text-sm text-gray-300">
                              <span class="mr-1">{{ commit.hexsha_short }}</span> - {{ commit.date|time_struct_since }}
                           </div>
                        </div>

                        <ul id="git-viewer-container" class="mb-8 rounded-b-lg border border-t-0 border-gray-600 bg-gray-900/50">
                        </ul>
                     </div>
                  </section>
               </div>
            </main>
         </div>

    </div>
</div>

<!-- ============================ ROW TEMPLATES =========================== -->

 <!-- FOLDER TEMPLATE -->

 <li id="row-template-folder" class="grid h-10 grid-cols-12 place-content-center gap-x-3 border-t px-3 border-gray-600" style="display: none">
   <div class="sm:col-span-8 md:col-span-3 flex items-center">
      <a class="gitfolder-link group flex items-center truncate hover:underline" href="#">

         <svg class="flex-none mr-2 text-gray-300 fill-current" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" role="img" width="1em" height="1em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 16 16">
            <path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path>
         </svg>
         <span class="gitfolder-name truncate"></span>

      </a>
   </div>

   {% comment %} <div class="group sm:col-span-4 md:col-span-7"></div>

   <a class="md:col-span-5 hidden md:flex items-center font-mono text-sm text-gray-400 hover:underline" href="#">
      <span class="truncate">This is my first commit message</span>
   </a>

   <a class="md:col-span-2 hidden md:flex truncate ml-auto text-sm text-gray-400 items-center hover:underline" href="/private/project/b789c859-9593-4292-b8fb-2ee6f9ace220/browser/17ccac71c15923b5233879fe6ed5bb8c5adde057/">
      2 weeks ago
   </a> {% endcomment %}
</li>

<!-- FILE TEMPLATE -->

<li id="row-template-file" class="grid h-10 grid-cols-12 place-content-center gap-x-3 border-t px-3 border-gray-600" style="display: none">
   <div class="sm:col-span-8 md:col-span-3 flex items-center">
      <a class="download-file-link group flex items-center truncate hover:underline" download="" href="#">

         <svg class="flex-none mr-2 text-gray-300 fill-current" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" role="img" width="1em" height="1em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 16 16">
            <path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path>
         </svg>
         <span class="download-file-name truncate"></span>
      </a>
   </div>
   <a class="file-size-link group sm:col-span-4 md:col-span-2 flex items-center justify-self-end truncate text-right font-mono text-[0.8rem] leading-6 text-gray-400 xl:pr-10 hover:underline" title="Download file" download="" href="#">
      <span class="file-size"></span>
      <div class="ml-2 flex h-5 w-5 items-center justify-center rounded border text-gray-500 border-gray-600 xl:ml-4">
         <svg class="" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" role="img" width="1em" height="1em" viewBox="0 0 32 32">
            <path fill="currentColor" d="M26 24v4H6v-4H4v4a2 2 0 0 0 2 2h20a2 2 0 0 0 2-2v-4zm0-10l-1.41-1.41L17 20.17V2h-2v18.17l-7.59-7.58L6 14l10 10l10-10z"></path>
         </svg>
      </div>
   </a>
   <a class="commit-message md:col-span-5 hidden md:flex items-center font-mono text-sm text-gray-400 hover:underline truncate" href="#"></a>
   <a class="commit-time-ago md:col-span-2 hidden md:flex truncate ml-auto text-sm text-gray-400 items-center hover:underline" href="#"></a>
</li>

<!-- %%%%%%%%%%%%%%%%%%%%%%%%%%%% ROW TEMPLATES %%%%%%%%%%%%%%%%%%%%%%%%%%% -->

<div id="loading_spinner" class="loading" style="display:none;"></div>

{% endblock right_panel %}


{% block inline_extra_js %}
<script>
   
$( document ).ready(function() {

   $("#loading_spinner").show();

   /**
    * jQuery ajax method with async = false, to fetch git tree data
    * @return {mix} - the git tree information
    */
   function fetch_git_tree() {
      return $.ajax({
         url : "{% url 'api:v1:one_project_gitexplorer_apiview' id=project.id hexsha=commit.hexsha %}",
         type : "GET",
         dataType : "json",
         async : false,
         success: function(data){
            if (data.success && data.data) {
               return data.data;
            }
            else {
               console.log("ERROR: " + data.error);
               return null;
            }
         },
         error: function (textStatus, errorThrown) {
            console.log("ERROR: " + data.textStatus + " & " + errorThrown);
            return null;
         }
      }).responseJSON.data;
   }

   /**
   * List files and folders based on the given path.
   * @param {string} path - The directory path to filter files. Root level if empty.
   * @returns {Object} - Dictionary with "files" and "folders".
   */
   function get_files_and_folders_at_path(path = "") {
      var result = {
         files: [],
         folders: []
      };

      if (path === "") {
         // Root-level files and folders
         globalGitTree.files.forEach(file => {
            const parts = file.path.split('/');
            if (parts.length === 1) {
                  result.files.push(file);
               } else if (!result.folders.some(folder => folder.name === parts[0])) {
                  result.folders.push({
                      name: parts[0],
                      path: `${parts[0]}`
                  });
               }
         });
      } else {
         // Files and folders within the specified directory
         const normalizedPath = path.endsWith("/") ? path : path + "/";
         globalGitTree.files.forEach(file => {
            if (file.path.startsWith(normalizedPath)) {
               const relativePath = file.path.substring(normalizedPath.length);
               const parts = relativePath.split('/');
               if (parts.length === 1) {
                  result.files.push(file);
               } else if (!result.folders.some(folder => folder.name === parts[0])) {
                  result.folders.push({
                     name: parts[0],
                     path: `${normalizedPath}${parts[0]}`
                  });
               }
            }
         });

         // Add a reference to the parent directory
         const parentPath = path.split('/').slice(0, -1).join('/') || "/";
         result.folders.unshift({
             name: "..",
             path: parentPath == "/" ? "" : parentPath
         });
      }

      // Sort folders alphabetically
      result.folders.sort();
  
      // Sort files alphabetically by their "name" property
      result.files.sort((a, b) => a.name.localeCompare(b.name));

      return result;
   }
   
   // Function to refresh UX
   function refresh_ux(path="") {
      
      // Empty the Git View
      $('#git-viewer-container').empty();

      // Fetch the files & folders at the path requested
      data = get_files_and_folders_at_path(path);
      
      // Populate the folders
      data.folders.forEach(function(folder) {
         $folder_row = $('#row-template-folder').clone();

         // Remove the "ID" (to prevent deletion/cleanup) and make it unique
         $folder_row.removeAttr('id');

         // Remove the "hidden" style (make it visible)
         $folder_row.removeAttr('style');

         // Folder Related Content
         var clickable_link = $folder_row.find(".gitfolder-link");
         clickable_link.attr("data-path", folder.path);
         clickable_link.on('click', function() {
            // Trigger the refresh_ux function with the path from the clicked link
            refresh_ux(path=$(this).attr('data-path'));
         });

         $folder_row.find(".gitfolder-name").text(folder.name);

         // FINALLY: Append the populated row to the table body
         // ---------------------------------------------------------------------
         $('#git-viewer-container').append($folder_row);
      });

      // Populate the files
      data.files.forEach(function(file) {
         $file_row = $('#row-template-file').clone();

         // Remove the "ID" (to prevent deletion/cleanup) and make it unique
         $file_row.removeAttr('id');

         // Remove the "hidden" style (make it visible)
         $file_row.removeAttr('style');

         // File Related Content
         $file_row.find(".download-file-link").attr("href", file.download_url);
         $file_row.find(".download-file-name").text(file.name);
         $file_row.find(".file-size-link").attr("href", file.download_url);
         $file_row.find(".file-size").text(file.size);

         // Commit Related Content
         $file_row.find(".commit-message").attr("href", file.commit.url).text(file.commit.message);
         $file_row.find(".commit-time-ago").attr("href", file.commit.url).text(file.commit.dt_since);

         // FINALLY: Append the populated row to the table body
         // ---------------------------------------------------------------------
         $('#git-viewer-container').append($file_row);
      });
   }

   // Fetch the Git Tree and store it as a constant for later re-use
   let globalGitTree = fetch_git_tree();

   if ((typeof globalGitTree !== 'undefined') || globalGitTree !== null) {
      refresh_ux(path="");
      {% comment %} // Example Usage
      console.log("Root level:", get_files_and_folders_at_path(""));
      console.log("Files and folders in 'images':", get_files_and_folders_at_path("images"));
      console.log("Files and folders in 'images/hello':", get_files_and_folders_at_path("images/hello")); {% endcomment %}
   }

   $("#loading_spinner").hide();
});
</script>
{% endblock inline_extra_js %}
