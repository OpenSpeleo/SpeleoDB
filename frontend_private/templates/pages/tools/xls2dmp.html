{% extends "pages/tools/base.html" %}
{% load static %}
{% load countries %}

{% block extra_css %}
<style>
    button.tool-action {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background: #fff;
        color: #474848;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    button.tool-action:hover {
        background: #f8f9fa;
        border-color: #999;
    }

    #downloadBtn {
        background: linear-gradient(135deg, #ff8900 0%, #ff6600 100%);
        color: #fff;
        border: none;
        padding: 10px 24px;
        font-size: 15px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(255, 137, 0, 0.3);
        transition: all 0.3s ease;
    }

    #downloadBtn:hover {
        background: linear-gradient(135deg, #ff9d1a 0%, #ff7a1a 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 137, 0, 0.4);
    }

    #downloadBtn:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(255, 137, 0, 0.3);
    }

    .trash {
        background: #ffecec;
        color: #b30000;
        border: 1px solid #f1b0b0;
    }

    .controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        outline: none;
    }

    table:focus {
        outline: none;
    }

    thead th {
        background: #f7f9fc;
        border-bottom: 2px solid #e6eefc;
        padding: 8px;
        font-size: 13px;
        position: sticky;
        top: 0;
    }

    tbody td {
        padding: 6px;
        border-bottom: 1px solid #eee;
        font-size: 13px;
    }

    tbody tr:nth-child(even) {
        background: #fcfdff;
    }

    td.invalid {
        background: #ffefef;
        border: 1px solid rgb(240, 88, 88);
    }

    td.actions button {
        padding: 4px 8px;
        margin: 0 2px;
        font-size: 13px;
        border-radius: 6px;
    }

    ul.instructions {
        list-style: disc;
        margin-block-end: 16px;
        margin-block-start: 16px;
        padding-inline-start: 40px;
    }

    .form-controls {
        display: flex;
        gap: 20px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .form-group label {
        color: #e2e8f0;
        font-size: 14px;
        font-weight: 500;
    }

    .date-input {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background: #fff;
        color: #474848;
        font-size: 14px;
        min-width: 200px;
        font-family: monospace;
    }

    .date-input.invalid-date {
        border: 2px solid #dc2626;
        background: #fef2f2;
    }

    /* Toggle Switch for Units */
    .unit-toggle {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 30px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #2196F3;
        transition: .4s;
        border-radius: 30px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: #ff8900;
    }

    input:checked + .slider:before {
        transform: translateX(30px);
    }

    .unit-label {
        color: #94a3b8;
        font-size: 14px;
        font-weight: 400;
        min-width: 50px;
        transition: all 0.3s ease;
    }

    .unit-label.active {
        color: #ffffff;
        font-weight: 700;
    }

    /* Spinner */
    .spinner {
        display: none;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #ff8900;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        margin-left: 12px;
    }

    .spinner.active {
        display: inline-block;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

</style>
{% endblock extra_css %}

{% block right_panel %}
<div class="grow">
    <div class="p-6">
        <h2 class="text-2xl text-slate-100 font-bold mb-5">Tool: Excel to Ariane DMP</h2>
        <p class="lead">
            <b>Instructions:</b>
            <ul class="instructions">
                <li>Use the Google Sheet Template below to prepare the data</li>
                <li>Paste data directly into the table (Ctrl/Cmd+V) or use the <strong>"Paste Excel"</strong> button</li>
                <li>You can add or remove rows; columns are fixed</li>
                <li>Click "Download as DMP" when you're done. Might take 3-5 secs</li>
                <li>Load the DMP into `Ariane` as if it was coming from the Mnemo</li>
            </ul>
        </p>

        <div class="my-3">
            <b>Please use the following:</b>
                <a href="https://docs.google.com/spreadsheets/d/15DwmV2-78g58LDbnx8cHAONfx2Gj_bqRMJxjDBLkJB0/edit?usp=sharing" 
                   target="_blank"
                   style="color: #ff8900; text-decoration: underline;"
                >
                    Google Spreadsheet Template
                </a>
        </div>
        
        <hr class="border-slate-600 mt-6">

        <div class="form-controls mt-6">

            <div class="form-group text-center">
                <label for="surveyDate">Survey Date</label>
                <input type="date" id="surveyDate" class="date-input">
            </div>

            <div class="form-group text-center">
                <label>Survey Units</label>
                <div class="unit-toggle">
                    <span class="unit-label" id="metersLabel">Meters</span>
                    <label class="switch">
                        <input type="checkbox" id="unitSwitch" checked>
                        <span class="slider"></span>
                    </label>
                    <span class="unit-label active" id="feetLabel">Feet</span>
                </div>
            </div>

            <div class="form-group text-center">
                <label>Survey Direction</label>
                <div class="unit-toggle">
                    <span class="unit-label active" id="inLabel">In</span>
                    <label class="switch">
                        <input type="checkbox" id="directionSwitch">
                        <span class="slider"></span>
                    </label>
                    <span class="unit-label" id="outLabel">Out</span>
                </div>
            </div>
        </div>

        <hr class="border-slate-600 mt-6">

        <div class="controls my-6">
            <button class="tool-action" id="addRowBtn">Add Row</button>
            <button class="tool-action" id="clearBtn">Clear All</button>
            <button class="tool-action" id="pasteExcelBtn">Paste Excel</button>
            <button class="tool-action" id="downloadBtn">Download as DMP</button>
            <div class="spinner" id="downloadSpinner"></div>
            <div id="status" style="margin-left:12px;"></div>
        </div>

        {% csrf_token %}

        <div style="overflow:auto;max-height:520px;border:1px solid #eef6ff;border-radius:8px">
            <table class="text-slate-800 text-center" id="dataTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Length</th>
                        <th>Azimuth</th>
                        <th>Depth</th>
                        <th>Left</th>
                        <th>Right</th>
                        <th>Up</th>
                        <th>Down</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<div id="loading_spinner" class="loading" style="display:none;"></div>

{% include 'snippets/modal_error.html' %}
{% endblock right_panel %}

{% block inline_extra_js %}
<script>
$(document).ready(function() {
    const COLUMNS = ['length', 'azimuth', 'depth', 'left', 'right', 'up', 'down'];
    const $tbody = $('#dataTable tbody');
    const $statusEl = $('#status');

    $(window).on('load', function() {
        $("body").click(function () {
            if ($("#modal_error").is(":visible")) {
                $("#modal_error").hide();
            }
        });
    });
    
    // Set max date to today (no future dates allowed)
    const today = new Date().toISOString().split('T')[0];
    $('#surveyDate').attr('max', today);
    
    // Unit switch handler
    let currentUnit = 'feet'; // Default unit is feet
    $('#unitSwitch').on('change', function() {
        if (this.checked) {
            currentUnit = 'feet';
            $('#metersLabel').removeClass('active');
            $('#feetLabel').addClass('active');
        } else {
            currentUnit = 'meters';
            $('#feetLabel').removeClass('active');
            $('#metersLabel').addClass('active');
        }
    });

    // Direction switch handler
    let surveyDirection = 'in'; // Default direction is in
    $('#directionSwitch').on('change', function() {
        if (this.checked) {
            surveyDirection = 'out';
            $('#inLabel').removeClass('active');
            $('#outLabel').addClass('active');
        } else {
            surveyDirection = 'in';
            $('#outLabel').removeClass('active');
            $('#inLabel').addClass('active');
        }
    });

    // Date validation function
    function validateDate(dateString) {
        if (!dateString) return false;
        const date = new Date(dateString);
        return date instanceof Date && !isNaN(date);
    }

    // Remove red highlight when user changes date
    $('#surveyDate').on('change input', function() {
        $(this).removeClass('invalid-date');
    });

    function validateCell(value, column) {
        const v = (value ?? '').trim();
        if (['length', 'depth'].includes(column)) return v !== '' && !isNaN(v) && isFinite(parseFloat(v));
        if (column === 'azimuth') {
            if (v === '') return false;
            const n = parseFloat(v);
            return !isNaN(n) && isFinite(n) && n >= 0 && n < 360;
        }
        if (['left', 'right', 'up', 'down'].includes(column)) {
            if (v === '') return true;
            const n = parseFloat(v);
            return !isNaN(n) && isFinite(n) && n >= 0;
        }
        return true;
    }

    function addRow(values = [], idx) {
        const index = idx ?? $tbody.children().length + 1;
        const html = `
<td>${index}</td>` + COLUMNS.map((col, j) => `
<td contenteditable="true" data-col="${col}">${escapeHtml(values[j] ?? '')}</td>`).join('') + `
<td class="actions">
    <button class="trash" title="Delete row">🗑️</button>
</td>`;
        const $tr = $('<tr>').html(html);
        $tbody.append($tr);
        // listeners are delegated; no per-cell binding needed
        // delete handler
        $tr.find('.trash').on('click', function() {
            $tr.remove();
            refreshIndexes();
            validateTable();
        });
    }

    function escapeHtml(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function refreshIndexes() {
        $tbody.children('tr').each(function(i) {
            $(this).children('td').first().text(i + 1);
        });
    }

    function renderRows(rows) {
        $tbody.empty();
        rows.forEach((r, i) => addRow(r, i + 1));
        refreshIndexes();
        validateTable();
    }

    function parseClipboardText(text) {
        if (!text) return [];
        const lines = text.replace(/\r/g, '\n').split(/\n/).filter(l => l.trim());
        const rows = lines.map(line => {
            let parts = line.split('\t');
            if (parts.length === 1) parts = line.split(',');
            return parts.map(p => p.replace(/^\uFEFF/, '').trim());
        });
        if (rows.length > 0 && /length/i.test(rows[0][0])) rows.shift();
        return rows;
    }

    $('#pasteExcelBtn').on('click', async function() {
        try {
            const text = await navigator.clipboard.readText();
            const rows = parseClipboardText(text);
            renderRows(rows);
            $statusEl.text(`Imported ${rows.length} rows.`);
        } catch {
            $statusEl.text('Unable to read clipboard. Try Ctrl+V directly.');
        }
    });

    $(document).on('paste', function(e) {
        const text = (e.originalEvent.clipboardData || window.clipboardData).getData('text/plain');
        if (!text) return;
        const sel = window.getSelection();
        if (sel && sel.anchorNode && $tbody[0].contains(sel.anchorNode)) {
            setTimeout(() => validateTable(), 50);
            return;
        }
        e.preventDefault();
        const rows = parseClipboardText(text);
        renderRows(rows);
        $statusEl.text(`Imported ${rows.length} rows.`);
    });

    function onCellInput(td) {
        const $td = $(td);
        const col = $td.data('col');
        const ok = validateCell($td.text(), col);
        $td.toggleClass('invalid', !ok);
        validateTable();
    }

    function validateTable() {
        let allValid = true;
        $('#dataTable tbody td[data-col]').each(function() {
            const $td = $(this);
            const col = $td.data('col');
            const ok = validateCell($td.text(), col);
            $td.toggleClass('invalid', !ok);
            if (!ok) allValid = false;
        });
        $('#status').text(allValid ? 'All cells valid.' : 'Some cells are invalid.')
                    .css({ 'color': allValid ? 'green' : 'red', 'font-weight': 'bold' });
        return allValid;
    }

    $('#addRowBtn').on('click', function() { 
        addRow(); 
        validateTable(); 
    });
    
    $('#clearBtn').on('click', function() { 
        $tbody.empty(); 
        $statusEl.text('Cleared.'); 
    });

    // Navigation helpers for Excel-like Enter behavior
    function getEditableTdFromTarget(target) {
        if (!target) return null;
        // If it's a text node, climb to its parent element first
        let node = target.nodeType === 3 ? target.parentElement : target; // 3 = TEXT_NODE
        if (!node) return null;
        const $node = $(node);
        const $td = $node.closest('td[data-col]');
        return $td.length ? $td[0] : null;
    }

    function placeCaretAtEnd(el) {
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    }

    function focusCell(cell) {
        if (!cell) return;
        $(cell).focus();
        placeCaretAtEnd(cell);
    }

    function moveToCellBelow(currentTd) {
        const $currentTd = $(currentTd);
        const $currentRow = $currentTd.parent();
        const $currentRowCells = $currentRow.find('td[data-col]');
        const colIndex = $currentRowCells.index($currentTd);
        const $nextRow = $currentRow.next();
        if ($nextRow.length) {
            const $nextRowCells = $nextRow.find('td[data-col]');
            focusCell($nextRowCells.eq(colIndex)[0] || $nextRowCells.last()[0]);
        } else {
            // Last row: blur to avoid inserting newlines
            $currentTd.blur();
            $('#dataTable').blur();
            // Also clear selection
            const sel = window.getSelection();
            if (sel) sel.removeAllRanges();
        }
    }

    // Prevent Enter from inserting line breaks; move to cell below instead
    $tbody[0].addEventListener('keydown', function(e) {
        if (e.key !== 'Enter') return;
        const td = getEditableTdFromTarget(e.target);
        if (!td) return;
        e.preventDefault();
        // Re-validate the whole table on commit-like action
        validateTable();
        moveToCellBelow(td);
    }, true);

    // Delegated input listener so ANY change in any cell revalidates the table
    $tbody.on('input', 'td[data-col]', function(e) {
        const td = getEditableTdFromTarget(e.target);
        if (!td) return;
        onCellInput(td);
    });

    // Some browsers fire beforeinput more consistently for contenteditable
    $tbody[0].addEventListener('beforeinput', function(e) {
        const td = getEditableTdFromTarget(e.target);
        if (!td) return;
        // Defer until after DOM mutation to read updated textContent
        setTimeout(() => onCellInput(td), 0);
    });

    // Keyup fallback to ensure validation runs after typing
    $tbody.on('keyup', 'td[data-col]', function(e) {
        const td = getEditableTdFromTarget(e.target);
        if (!td) return;
        onCellInput(td);
    });

    // Also validate on blur to catch edits that don't emit input in some browsers
    $tbody[0].addEventListener('blur', function(e) {
        const td = getEditableTdFromTarget(e.target);
        if (!td) return;
        onCellInput(td);
    }, true);

    function tableToCsv() {
        const rows = [];
        $tbody.children('tr').each(function() {
            const row = [];
            $(this).find('td[data-col]').each(function() {
                row.push($(this).text().trim());
            });
            rows.push(row);
        });
        return rows.map(r => r.map(cell => { 
            if(cell.includes(',') || cell.includes('"') || cell.includes('\n')) 
                return '"'+cell.replace(/"/g,'""')+'"'; 
            return cell; 
        }).join(',')).join('\n');
    }

    $('#downloadBtn').on('click', function() {
        // Validate the table before proceeding
        if (!validateTable()) {
            $('#status').text('Some cells are invalid. Please correct them before downloading.')
                        .css({ 'color': 'red', 'font-weight': 'bold' });
            return;
        }

        // Validate the survey date
        const surveyDate = $('#surveyDate').val();
        if (!validateDate(surveyDate)) {
            $('#surveyDate').addClass('invalid-date');
            $('#status').text('Please enter a valid survey date.')
                        .css({ 'color': 'red', 'font-weight': 'bold' });
            return;
        } else {
            $('#surveyDate').removeClass('invalid-date');
        }

        // Collect table data
        const rows = [];
        $('#dataTable tbody tr').each(function() {
            const row = {};
            $(this).find('td[data-col]').each(function() {
                const col = $(this).data('col');
                row[col] = $(this).text().trim();
            });
            if (Object.keys(row).length > 0) {
                rows.push(row);
            }
        });

        var csrftoken = $('input[name^=csrfmiddlewaretoken]').val();

        // Show spinner
        $("#loading_spinner").show();

        // AJAX call with survey date, unit, and direction
        $.ajax({
            url: "{% url 'api:v1:tool-xls2dmp' %}",
            method: "POST",
            data: JSON.stringify({ 
                shots: rows,
                survey_date: surveyDate,
                unit: currentUnit,
                direction: surveyDirection
            }),
            contentType: "application/json; charset=utf-8",
            cache: false,
            beforeSend: function (xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
                return true;
            },
            success: function(response) {
                const blob = new Blob([response], { type: 'application/octet-stream' });
                let a = document.createElement('a');
                document.body.appendChild(a);

                a.href = window.URL.createObjectURL(blob);
                a.style.display = 'none';
                a.download = 'survey.dmp';
                a.click();

                window.URL.revokeObjectURL(a.href);
                a.remove();
                
                // Hide spinner and show success
                $("#loading_spinner").hide();
                $('#downloadBtn').prop('disabled', false);
                $('#status').text('Download successful!')
                            .css({ 'color': 'green', 'font-weight': 'bold' });
            },
            error: function(xhr, status, error) {
                // Hide spinner and show error
                $("#loading_spinner").hide();
                $('#downloadBtn').prop('disabled', false);
                
                // Try to extract error message from response
                let errorMessage = error;
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                } else if (xhr.responseJSON && xhr.responseJSON.detail) {
                    errorMessage = xhr.responseJSON.detail;
                } else if (xhr.response) {
                    // Response might be a Blob, try to read it as text
                    const reader = new FileReader();
                    reader.onload = function() {
                        try {
                            const response = JSON.parse(reader.result);
                            errorMessage = response.error || response.detail || response.message || error;
                        } catch (e) {
                            errorMessage = reader.result.substring(0, 200); // Limit length
                        }
                        $("#modal_error_txt").text(errorMessage);
                        $("#modal_error").css('display', 'flex');
                    };
                    reader.readAsText(xhr.response);
                    return; // Exit early as we'll show modal in the reader callback
                }
                
                // Display error in modal
                $("#modal_error_txt").text(errorMessage);
                $("#modal_error").css('display', 'flex');
                
                $('#status').text('Error occurred. See details.')
                            .css({ 'color': 'red', 'font-weight': 'bold' });
            },
            xhrFields: {
                responseType: 'blob'
            }
        });

    });

    renderRows([]);
});
</script>
{% endblock inline_extra_js %}
