{% extends "pages/tools/base.html" %}
{% load static % }

{% block extra_css %}
{{ block.super }}

<style>
    button.tool-action {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background: #fff;
        color: #474848;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    button.tool-action:hover {
        background: #f8f9fa;
        border-color: #999;
    }

    #downloadBtn {
        background: linear-gradient(135deg, #ff8900 0%, #ff6600 100%);
        color: #fff;
        border: none;
        padding: 10px 24px;
        font-size: 15px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(255, 137, 0, 0.3);
        transition: all 0.3s ease;
    }

    #downloadBtn:hover {
        background: linear-gradient(135deg, #ff9d1a 0%, #ff7a1a 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 137, 0, 0.4);
    }

    #downloadBtn:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(255, 137, 0, 0.3);
    }

    .trash {
        background: #ffecec;
        color: #b30000;
        border: 1px solid #f1b0b0;
    }

    .controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        outline: none;
    }

    table:focus {
        outline: none;
    }

    thead th {
        background: #f7f9fc;
        border-bottom: 2px solid #e6eefc;
        padding: 8px;
        font-size: 13px;
        position: sticky;
        top: 0;
    }

    tbody td {
        padding: 6px;
        border-bottom: 1px solid #eee;
        font-size: 13px;
    }

    tbody tr:nth-child(even) {
        background: #fcfdff;
    }

    td.invalid {
        background: #ffefef;
        border: 1px solid rgb(240, 88, 88);
    }

    td.actions button {
        padding: 4px 8px;
        margin: 0 2px;
        font-size: 13px;
        border-radius: 6px;
    }

    ul.instructions {
        list-style: disc;
        margin-block-end: 16px;
        margin-block-start: 16px;
        padding-inline-start: 40px;
    }

    .form-controls {
        display: flex;
        gap: 20px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .form-group label {
        color: #e2e8f0;
        font-size: 14px;
        font-weight: 500;
    }

    .date-input {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background: #fff;
        color: #474848;
        font-size: 14px;
        min-width: 200px;
        font-family: monospace;
    }

    .date-input.invalid-date {
        border: 2px solid #dc2626;
        background: #fef2f2;
    }
    
    /* Mobile responsive styles */
    @media (max-width: 768px) {
        .form-controls {
            flex-direction: column;
            align-items: stretch;
            gap: 16px;
        }
        
        .form-group {
            width: 100%;
        }
        
        .form-group.flex-1 {
            flex: none;
            width: 100%;
        }
        
        .form-group.text-center {
            text-align: left;
        }
        
        .date-input,
        .text-input {
            min-width: 100%;
            width: 100%;
        }
        
        .controls {
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .controls button {
            flex: 1 1 calc(50% - 4px);
            min-width: 120px;
        }
        
        table {
            font-size: 12px;
        }
        
        thead th,
        tbody td {
            padding: 4px;
            font-size: 11px;
        }
    }

    /* Toggle Switch for Units */
    .unit-toggle {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 30px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #2196F3;
        transition: .4s;
        border-radius: 30px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: #ff8900;
    }

    input:checked + .slider:before {
        transform: translateX(30px);
    }

    .unit-label {
        color: #94a3b8;
        font-size: 14px;
        font-weight: 400;
        min-width: 50px;
        transition: all 0.3s ease;
    }

    .unit-label.active {
        color: #ffffff;
        font-weight: 700;
    }

    /* Spinner */
    .spinner {
        display: none;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #ff8900;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        margin-left: 12px;
    }

    .spinner.active {
        display: inline-block;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

</style>
{% endblock extra_css %}

{% block right_panel %}
<div class="grow">
    <div class="p-6">
        <h2 class="text-2xl text-slate-100 font-bold mb-5">Tool: Excel to Ariane DMP</h2>
        <p class="lead">
            <b>Instructions:</b>
            <ul class="instructions">
                <li>Use the Google Sheet Template below to prepare the data</li>
                <li>Use the "<span class="text-orange-300">Paste Excel</span>" button to copy the data into the table</li>
                <li>You can add or remove rows, however columns are fixed</li>
                <li>Click "<span class="text-orange-300">Download as DMP</span>" when you're done</li>
                <li>Load the DMP into Ariane as if it was coming from the Mnemo</li>
            </ul>
        </p>

        <div class="my-4">
            <b>Please use the following:</b>
                <a href="https://docs.google.com/spreadsheets/d/15DwmV2-78g58LDbnx8cHAONfx2Gj_bqRMJxjDBLkJB0/edit?usp=sharing"
                   class="text-orange-500 underline"
                   target="_blank"
                >
                    Google Spreadsheet Template
                </a>
        </div>

        <div class="my-4 text-orange-300">
            <b>Note:</b> This tool <b class="underline">does not</b> store any of the data sent. Please back up your data and result.
        </div>
        
        <hr class="border-slate-600 mt-6">

        <div class="form-controls mt-6">

            <div class="form-group text-center">
                <label for="surveyDate">Survey Date</label>
                <input type="date" id="surveyDate" class="date-input">
            </div>

            <div class="form-group text-center">
                <label>Survey Units</label>
                <div class="unit-toggle">
                    <span class="unit-label" id="metersLabel">Meters</span>
                    <label class="switch">
                        <input type="checkbox" id="unitSwitch" checked>
                        <span class="slider"></span>
                    </label>
                    <span class="unit-label active" id="feetLabel">Feet</span>
                </div>
            </div>

            <div class="form-group text-center">
                <label>Survey Direction</label>
                <div class="unit-toggle">
                    <span class="unit-label active" id="inLabel">In</span>
                    <label class="switch">
                        <input type="checkbox" id="directionSwitch">
                        <span class="slider"></span>
                    </label>
                    <span class="unit-label" id="outLabel">Out</span>
                </div>
            </div>
        </div>

        <hr class="border-slate-600 mt-6">

        <div class="controls my-6">
            <button class="tool-action" id="addRowBtn">Add Row</button>
            <button class="tool-action" id="clearBtn">Clear All</button>
            <button class="tool-action" id="pasteExcelBtn">Paste Excel</button>
            <button class="tool-action" id="downloadBtn">Download as DMP</button>
            <div class="spinner" id="downloadSpinner"></div>
            <div id="status" style="margin-left:12px;"></div>
        </div>

        {% csrf_token %}

        <div style="overflow:auto;max-height:520px;border:1px solid #eef6ff;border-radius:8px">
            <table class="text-slate-800 text-center" id="dataTable">
                <thead>
                    <tr>
                        <th>Station #</th>
                        <th>Station Depth</th>
                        <th>Shot Length</th>
                        <th>Shot Azimuth</th>
                        <th>Left</th>
                        <th>Right</th>
                        <th>Up</th>
                        <th>Down</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<div id="loading_spinner" class="loading" style="display:none;"></div>

{% include 'snippets/modal_error.html' %}
{% endblock right_panel %}

{% block inline_extra_js %}
<script>
$(document).ready(function() {
    const COLUMNS = ['depth', 'length', 'azimuth', 'left', 'right', 'up', 'down'];
    const $tbody = $('#dataTable tbody');
    const $statusEl = $('#status');

    $(window).on('load', function() {
        $("body").click(function () {
            if ($("#modal_error").is(":visible")) {
                $("#modal_error").hide();
            }
        });
    });
    
    const today = new Date().toISOString().split('T')[0];
    $('#surveyDate').attr('max', today);
    
    let currentUnit = 'feet';
    $('#unitSwitch').on('change', function() {
        if (this.checked) {
            currentUnit = 'feet';
            $('#metersLabel').removeClass('active');
            $('#feetLabel').addClass('active');
        } else {
            currentUnit = 'meters';
            $('#feetLabel').removeClass('active');
            $('#metersLabel').addClass('active');
        }
    });

    let surveyDirection = 'in';
    $('#directionSwitch').on('change', function() {
        if (this.checked) {
            surveyDirection = 'out';
            $('#inLabel').removeClass('active');
            $('#outLabel').addClass('active');
        } else {
            surveyDirection = 'in';
            $('#outLabel').removeClass('active');
            $('#inLabel').addClass('active');
        }
    });

    function validateDate(dateString) {
        if (!dateString) return false;
        const date = new Date(dateString);
        return date instanceof Date && !isNaN(date);
    }

    $('#surveyDate').on('change input', function() {
        $(this).removeClass('invalid-date');
    });

    function validateCell(value, column, isLastRow = false) {
        const v = (value ?? '').trim();
        
        if (column === 'depth') {
            if (v === '') return false;
            const n = parseFloat(v);
            return !isNaN(n) && isFinite(n) && n >= 0;
        }
        
        if (column === 'length') {
            if (isLastRow) return v === '';
            if (v === '') return false;
            const n = parseFloat(v);
            return !isNaN(n) && isFinite(n) && n >= 0;
        }
        
        if (column === 'azimuth') {
            if (isLastRow) return v === '';
            if (v === '') return false;
            const n = parseFloat(v);
            return !isNaN(n) && isFinite(n) && n >= 0 && n < 360;
        }
        
        if (['left', 'right', 'up', 'down'].includes(column)) {
            if (isLastRow) return v === '';
            if (v === '') return true;
            const n = parseFloat(v);
            return !isNaN(n) && isFinite(n) && n >= 0;
        }
        
        return true;
    }

    function addRow(values = [], idx) {
        const index = idx ?? $tbody.children().length + 1;
        const html = `
<td>${index}</td>` + COLUMNS.map((col, j) => `
<td contenteditable="true" data-col="${col}">${escapeHtml(values[j] ?? '')}</td>`).join('') + `
<td class="actions">
    <button class="trash" title="Delete row">üóëÔ∏è</button>
</td>`;
        const $tr = $('<tr>').html(html);
        $tbody.append($tr);
        $tr.find('.trash').on('click', function() {
            $tr.remove();
            refreshIndexes();
            validateTable();
        });
    }

    function escapeHtml(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function refreshIndexes() {
        $tbody.children('tr').each(function(i) {
            $(this).children('td').first().text(i + 1);
        });
    }

    function renderRows(rows) {
        $tbody.empty();
        rows.forEach((r, i) => addRow(r, i + 1));
        refreshIndexes();
        validateTable();
    }

    function parseClipboardText(text) {
        if (!text) return [];
        
        const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n').filter(l => l.trim());
        
        let rows = lines.map(line => {
            let parts = line.split('\t');
            
            if (parts.length === 1 && line.includes(',')) {
                parts = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        parts.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                parts.push(current);
            }
            
            return parts.map(p => {
                let cleaned = p.replace(/^\uFEFF/, '').trim();
                if (cleaned.startsWith('"') && cleaned.endsWith('"')) {
                    cleaned = cleaned.slice(1, -1);
                }
                return cleaned;
            });
        });
        
        if (rows.length > 0 && rows[0].length > 0) {
            const firstCell = rows[0][0].trim();
            
            if (/^station/i.test(firstCell)) {
                const headerRow = rows[0];
                const stationColIndex = headerRow.findIndex(cell => 
                    /^station\s*#?$/i.test(cell.trim())
                );
                
                rows.shift();
                
                if (stationColIndex !== -1) {
                    rows = rows.map(row => {
                        const newRow = [...row];
                        newRow.splice(stationColIndex, 1);
                        return newRow;
                    });
                }
            }
        }
        
        rows = rows.filter(row => row.some(cell => cell.trim() !== ''));
        
        return rows;
    }

    $('#pasteExcelBtn').on('click', async function() {
        try {
            const text = await navigator.clipboard.readText();
            const rows = parseClipboardText(text);
            renderRows(rows);
            $statusEl.text(`Imported ${rows.length} rows.`);
        } catch {
            $statusEl.text('Unable to read clipboard. Try Ctrl+V directly.');
        }
    });

    function onCellInput(td) {
        const $td = $(td);
        const col = $td.data('col');
        const $row = $td.parent();
        const $allRows = $tbody.children('tr');
        const isLastRow = $allRows.last().is($row);
        const ok = validateCell($td.text(), col, isLastRow);
        $td.toggleClass('invalid', !ok);
        validateTable();
    }

    function validateTable() {
        let allValid = true;
        let lastRowErrors = [];
        const $allRows = $tbody.children('tr');
        const $lastRow = $allRows.last();
        
        $('#dataTable tbody td[data-col]').each(function() {
            const $td = $(this);
            const col = $td.data('col');
            const $row = $td.parent();
            const isLastRow = $lastRow.is($row);
            const ok = validateCell($td.text(), col, isLastRow);
            $td.toggleClass('invalid', !ok);
            
            if (!ok) {
                allValid = false;
                if (isLastRow && $td.text().trim() !== '' && col !== 'depth') {
                    const fieldName = col.charAt(0).toUpperCase() + col.slice(1);
                    if (!lastRowErrors.includes(fieldName)) {
                        lastRowErrors.push(fieldName);
                    }
                }
            }
        });
        
        let statusMessage = 'All cells valid.';
        if (!allValid) {
            if (lastRowErrors.length > 0) {
                statusMessage = `Error: The last row should only have Station Depth. Remove: ${lastRowErrors.join(', ')}.`;
            } else {
                statusMessage = 'Some cells are invalid.';
            }
        }
        
        $('#status').text(statusMessage)
                    .css({ 'color': allValid ? 'green' : 'red', 'font-weight': 'bold' });
        return allValid;
    }

    $('#addRowBtn').on('click', function() { 
        addRow(); 
        validateTable(); 
    });
    
    $('#clearBtn').on('click', function() { 
        $tbody.empty(); 
        $statusEl.text('Cleared.'); 
    });

    function getEditableTdFromTarget(target) {
        if (!target) return null;
        const node = target.nodeType === 3 ? target.parentElement : target;  // 3 = TEXT_NODE
        if (!node) return null;
        const $node = $(node);
        const $td = $node.closest('td[data-col]');
        return $td.length ? $td[0] : null;
    }

    function placeCaretAtEnd(el) {
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    }

    function focusCell(cell) {
        if (!cell) return;
        $(cell).focus();
        placeCaretAtEnd(cell);
    }

    function moveToCellBelow(currentTd) {
        const $currentTd = $(currentTd);
        const $currentRow = $currentTd.parent();
        const $currentRowCells = $currentRow.find('td[data-col]');
        const colIndex = $currentRowCells.index($currentTd);
        const $nextRow = $currentRow.next();
        if ($nextRow.length) {
            const $nextRowCells = $nextRow.find('td[data-col]');
            focusCell($nextRowCells.eq(colIndex)[0] || $nextRowCells.last()[0]);
        } else {
            $currentTd.blur();
            $('#dataTable').blur();
            const sel = window.getSelection();
            if (sel) sel.removeAllRanges();
        }
    }

    $tbody[0].addEventListener('keydown', function(e) {
        if (e.key !== 'Enter') return;
        const td = getEditableTdFromTarget(e.target);
        if (!td) return;
        e.preventDefault();
        validateTable();
        moveToCellBelow(td);
    }, true);

    $tbody.on('input', 'td[data-col]', function(e) {
        const td = getEditableTdFromTarget(e.target);
        if (!td) return;
        onCellInput(td);
    });

    $tbody[0].addEventListener('beforeinput', function(e) {
        const td = getEditableTdFromTarget(e.target);
        if (!td) return;
        setTimeout(() => onCellInput(td), 0);
    });

    $tbody.on('keyup', 'td[data-col]', function(e) {
        const td = getEditableTdFromTarget(e.target);
        if (!td) return;
        onCellInput(td);
    });

    $tbody[0].addEventListener('blur', function(e) {
        const td = getEditableTdFromTarget(e.target);
        if (!td) return;
        onCellInput(td);
    }, true);

    function tableToCsv() {
        const rows = [];
        $tbody.children('tr').each(function() {
            const row = [];
            $(this).find('td[data-col]').each(function() {
                row.push($(this).text().trim());
            });
            rows.push(row);
        });
        return rows.map(r => r.map(cell => { 
            if(cell.includes(',') || cell.includes('"') || cell.includes('\n')) 
                return '"'+cell.replace(/"/g,'""')+'"'; 
            return cell; 
        }).join(',')).join('\n');
    }

    $('#downloadBtn').on('click', function() {
        if (!validateTable()) {
            $('#status').text('Some cells are invalid. Please correct them before downloading.')
                        .css({ 'color': 'red', 'font-weight': 'bold' });
            return;
        }

        const surveyDate = $('#surveyDate').val();
        if (!validateDate(surveyDate)) {
            $('#surveyDate').addClass('invalid-date');
            $('#status').text('Please enter a valid survey date.')
                        .css({ 'color': 'red', 'font-weight': 'bold' });
            return;
        } else {
            $('#surveyDate').removeClass('invalid-date');
        }

        const rows = [];
        $('#dataTable tbody tr').each(function() {
            const row = {};
            $(this).find('td[data-col]').each(function() {
                const col = $(this).data('col');
                row[col] = $(this).text().trim();
            });
            if (Object.keys(row).length > 0) {
                rows.push(row);
            }
        });

        var csrftoken = $('input[name^=csrfmiddlewaretoken]').val();

        $("#loading_spinner").show();

        $.ajax({
            url: "{% url 'api:v1:tool-xls2dmp' %}",
            method: "POST",
            data: JSON.stringify({ 
                shots: rows,
                survey_date: surveyDate,
                unit: currentUnit,
                direction: surveyDirection
            }),
            contentType: "application/json; charset=utf-8",
            cache: false,
            beforeSend: function (xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
                return true;
            },
            success: function(response) {
                const blob = new Blob([response], { type: 'application/octet-stream' });
                const a = document.createElement('a');
                document.body.appendChild(a);
                a.href = window.URL.createObjectURL(blob);
                a.style.display = 'none';
                a.download = 'survey.dmp';
                a.click();
                window.URL.revokeObjectURL(a.href);
                a.remove();
                
                $("#loading_spinner").hide();
                $('#downloadBtn').prop('disabled', false);
                $('#status').text('Download successful!')
                            .css({ 'color': 'green', 'font-weight': 'bold' });
            },
            error: function(xhr, status, error) {
                $("#loading_spinner").hide();
                $('#downloadBtn').prop('disabled', false);
                
                let errorMessage = error;
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                } else if (xhr.responseJSON && xhr.responseJSON.detail) {
                    errorMessage = xhr.responseJSON.detail;
                } else if (xhr.responseText) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage = response.error || response.detail || response.message || error;
                    } catch (e) {
                        errorMessage = xhr.responseText.substring(0, 200);
                    }
                }
                
                $("#modal_error_txt").text(errorMessage);
                $("#modal_error").css('display', 'flex');
                $('#status').text('Error occurred. See details.')
                            .css({ 'color': 'red', 'font-weight': 'bold' });
            }
        });

    });

    renderRows([]);
});
</script>
{% endblock inline_extra_js %}
