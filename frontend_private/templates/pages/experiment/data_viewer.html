{% extends "pages/experiment/base.html" %}
{% load static %}

{% block extra_css %}
<style>
    /* Custom AG Grid Dark Theme Overrides */
    .ag-theme-alpine-dark {
        --ag-background-color: rgb(30, 41, 59);
        --ag-header-background-color: rgb(51, 65, 85);
        --ag-odd-row-background-color: rgb(30, 41, 59);
        --ag-header-foreground-color: rgb(226, 232, 240);
        --ag-foreground-color: rgb(203, 213, 225);
        --ag-border-color: rgb(71, 85, 105);
        --ag-row-hover-color: rgba(99, 102, 241, 0.1);
        --ag-selected-row-background-color: rgba(99, 102, 241, 0.2);
        --ag-range-selection-background-color: rgba(99, 102, 241, 0.2);
        --ag-input-focus-border-color: rgb(99, 102, 241);
    }
    
    .ag-theme-alpine-dark .ag-header-cell-text {
        font-weight: 600;
    }
    
    .ag-theme-alpine-dark .ag-cell {
        line-height: 40px;
    }
</style>
{% endblock extra_css %}

{% block right_panel %}
<div class="grow">

    <!-- Panel body -->
    <div class="p-6 space-y-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
            <!-- Title -->
            <div>
                <h2 class="text-3xl text-slate-100 font-bold">Data Viewer</h2>
                <p class="text-slate-400 mt-2">View and export experiment data in table format</p>
            </div>
            
            <!-- Export Button -->
            <div class="flex gap-3">
                <button 
                    id="refreshDataBtn"
                    type="button"
                    class="px-4 py-2.5 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-md text-sm font-medium transition-colors duration-200 flex items-center gap-2"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span>Refresh</span>
                </button>
                <button 
                    id="exportExcelBtn"
                    type="button"
                    class="px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-sm font-semibold transition-colors duration-200 flex items-center gap-2 shadow-md hover:shadow-lg"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Export to Excel</span>
                </button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="flex items-center justify-center min-h-[400px]">
            <div class="flex flex-col items-center gap-4">
                <svg class="animate-spin h-12 w-12 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-slate-300 font-medium">Loading data...</p>
            </div>
        </div>

        <!-- Data Grid Container -->
        <div id="dataGridContainer" class="hidden">
            <!-- Stats -->
            <div class="bg-slate-700/50 rounded-lg p-4 mb-4 flex flex-wrap gap-6">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span class="text-slate-300 text-sm">
                        <span class="font-semibold">Total Records:</span> 
                        <span id="recordCount" class="text-indigo-400 font-bold">0</span>
                    </span>
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    <span class="text-slate-300 text-sm">
                        <span class="font-semibold">Columns:</span> 
                        <span id="columnCount" class="text-green-400 font-bold">0</span>
                    </span>
                </div>
            </div>

            <!-- AG Grid -->
            <div id="dataGrid" class="ag-theme-alpine-dark" style="width: 100%; height: 600px;"></div>

            <!-- Help Text -->
            <div class="mt-4 bg-slate-700/30 border border-slate-600 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div class="text-sm text-slate-300">
                        <p class="font-semibold mb-1">Tips:</p>
                        <ul class="list-disc list-inside space-y-1 text-slate-400">
                            <li>Click column headers to sort data</li>
                            <li>Use filters by clicking the menu icon in column headers</li>
                            <li>Click "Export to Excel" to download all data as an Excel file</li>
                            <li>Resize columns by dragging the column borders</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden">
            <div class="bg-red-900/30 border border-red-600/50 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-red-200 mb-1">Error Loading Data</p>
                        <p id="errorText" class="text-sm text-red-300/90"></p>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>
{% endblock right_panel %}

{% block extra_js %}
<script src="{% url 'url_reverse.js' %}"></script>

{% if debug %}
<script src="{% static 'private/js/vendors/ag-grid-community.min.js' %}"></script>
{% else %}
<script 
    src="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/34.2.0/ag-grid-community.min.js" 
    integrity="sha512-Zhgoh+vE3dmd0rcKatRMB9x6xlTo5e7+YHNeenVQ003lt2RDmsoOAxhvE/rAuENdBTZXaR4W00He9S0Gu/1+7w==" 
    crossorigin="anonymous" 
    referrerpolicy="no-referrer">
</script>
{% endif %}

{% endblock extra_js %}

{% block inline_extra_js %}
<script>
$(window).on('load', function() {
    'use strict';
    
    // ============================================
    // Global Variables
    // ============================================
    let gridApi = null;
    const experimentId = "{{ experiment.id }}";
    const gisToken = "{{ experiment.gis_token }}";
    let experimentFields = null; // Will store field definitions with order and names
    
    // ============================================
    // Data Loading
    // ============================================
    async function loadExperimentData() {
        try {
            showLoading();
            
            // First, fetch experiment details to get field definitions
            const experimentResponse = await fetch(
                Urls["api:v1:experiment-detail"](experimentId), 
                { credentials: 'same-origin' }
            );
            
            if (!experimentResponse.ok) {
                throw new Error(`Failed to fetch experiment details: ${experimentResponse.status}`);
            }
            
            const experimentData = await experimentResponse.json();
            experimentFields = experimentData.data?.experiment_fields || experimentData.experiment_fields || [];
            
            // Sort fields by order parameter
            if (Array.isArray(experimentFields)) {
                experimentFields.sort((a, b) => {
                    const orderA = a.order !== undefined ? a.order : 999;
                    const orderB = b.order !== undefined ? b.order : 999;
                    return orderA - orderB;
                });
            }
            
            // Fetch GeoJSON data from the API
            const apiUrl = "{{ request.scheme }}://{{ request.get_host }}{% url 'api:v1:gis-ogc:experiment' gis_token=experiment.gis_token %}";
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
            }
            
            const geojsonData = await response.json();
            
            if (!geojsonData || !geojsonData.features || !Array.isArray(geojsonData.features)) {
                throw new Error('Invalid GeoJSON data format');
            }
            
            // Transform GeoJSON features to table rows
            const rows = transformGeoJSONToRows(geojsonData.features);
            
            // Create grid
            createDataGrid(rows);
            
            // Update stats
            $('#recordCount').text(rows.length);
            $('#columnCount').text(Object.keys(rows[0] || {}).length);
            
            showDataGrid();
            
        } catch (error) {
            console.error('Error loading data:', error);
            showError(error.message);
        }
    }
    
    function transformGeoJSONToRows(features) {
        const rows = [];
        
        features.forEach(feature => {
            const props = feature.properties || {};
            const geometry = feature.geometry || {};
            const coordinates = geometry.coordinates || [];
            
            // Build row object with standard fields first
            const row = {
                'Project Name': props.project_name || '',
                'Project ID': props.project_id || '',
                'Station ID': props.station_id || '',
                'Station Name': props.station_name || '',
                'Longitude': coordinates[0] || '',
                'Latitude': coordinates[1] || '',
            };
            
            // Add experiment fields in the order defined by experiment_fields
            if (experimentFields && Array.isArray(experimentFields)) {
                experimentFields.forEach(field => {
                    const fieldId = field.id;
                    const fieldName = field.name;
                    
                    // Skip status fields
                    if (fieldName && (fieldName.toLowerCase() === 'status')) {
                        return;
                    }
                    
                    // Get value by field UUID from properties
                    if (fieldId in props) {
                        row[fieldName] = formatValue(props[fieldId]);
                    }
                });
            } else {
                // Fallback: if experimentFields not loaded, add all remaining properties
                const skipFields = ['id', 'station_name', 'station_id', 'project_name', 'project_id', 'created_by', 'status'];
                
                Object.keys(props).forEach(key => {
                    if (!skipFields.includes(key) && key.toLowerCase() !== 'status') {
                        // Format field name: flow -> Flow
                        const fieldName = key
                            .replace(/_/g, ' ')
                            .replace(/\b\w/g, l => l.toUpperCase());
                        row[fieldName] = formatValue(props[key]);
                    }
                });
            }
            
            rows.push(row);
        });
        
        // Remove status columns from all rows to ensure they don't appear anywhere
        const cleanedRows = rows.map(row => {
            const cleanedRow = {};
            Object.keys(row).forEach(key => {
                if (key.toLowerCase() !== 'status') {
                    cleanedRow[key] = row[key];
                }
            });
            return cleanedRow;
        });
        
        return cleanedRows;
    }
    
    function formatValue(value) {
        if (value === null || value === undefined) {
            return '';
        }
        if (typeof value === 'object') {
            return JSON.stringify(value);
        }
        return String(value);
    }
    
    // ============================================
    // AG Grid Setup
    // ============================================
    // Custom header name mapping - map field keys to display names
    const headerNameMap = {
        // Add your custom header name mappings here
        // Example: 'Project Name': 'Project',
        // 'Station ID': 'Station Identifier',
    };
    
    // Columns to exclude from the table
    const excludedColumns = ['Status', 'status'];
    
    function createDataGrid(rows) {
        if (rows.length === 0) {
            showError('No data available to display');
            return;
        }
        
        // Generate column definitions from first row
        const firstRow = rows[0];
        const columnDefs = Object.keys(firstRow)
            .filter(key => !excludedColumns.includes(key)) // Filter out excluded columns
            .map(key => ({
                field: key,
                headerName: headerNameMap[key] || key, // Use custom name if mapped, otherwise use original
                sortable: true,
                filter: true,
                resizable: true,
                minWidth: 150,
                flex: 1,
            }));
        
        // Grid options
        const gridOptions = {
            columnDefs: columnDefs,
            rowData: rows,
            defaultColDef: {
                sortable: true,
                filter: true,
                resizable: true,
            },
            enableCellTextSelection: true,
            ensureDomOrder: true,
            pagination: true,
            paginationPageSize: 50,
            paginationPageSizeSelector: [20, 50, 100, 200],
            animateRows: true,
            rowSelection: 'multiple',
        };
        
        // Create the grid
        const gridDiv = document.querySelector('#dataGrid');
        gridApi = agGrid.createGrid(gridDiv, gridOptions);
    }
    
    // ============================================
    // Export to Excel
    // ============================================
    $('#exportExcelBtn').on('click', async function() {
        const $btn = $(this);
        const originalHtml = $btn.html();
        
        try {
            // Disable button and show loading
            $btn.prop('disabled', true).html(`
                <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Exporting...</span>
            `);
            
            // Call export API
            const response = await fetch(
                Urls['api:v1:experiment-export-excel'](experimentId), 
                {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    credentials: 'same-origin',
                }
            );
            
            if (!response.ok) {
                throw new Error(`Export failed: ${response.status} ${response.statusText}`);
            }
            
            // Get filename from Content-Disposition header
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'experiment_data.xlsx';
            if (contentDisposition) {
                // Match filename with or without quotes, but don't include quotes in capture
                const filenameMatch = contentDisposition.match(/filename=["']?([^"';]+)["']?/);
                if (filenameMatch && filenameMatch[1]) {
                    filename = filenameMatch[1].trim();
                }
            }
            
            // Download file with proper MIME type
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            
            // Show success message
            $btn.removeClass('bg-indigo-600 hover:bg-indigo-700')
                .addClass('bg-green-600 hover:bg-green-700')
                .html(`
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>Exported!</span>
                `);
            
            setTimeout(() => {
                $btn.removeClass('bg-green-600 hover:bg-green-700')
                    .addClass('bg-indigo-600 hover:bg-indigo-700')
                    .html(originalHtml)
                    .prop('disabled', false);
            }, 2000);
            
        } catch (error) {
            console.error('Export error:', error);
            alert('Failed to export data: ' + error.message);
            $btn.html(originalHtml).prop('disabled', false);
        }
    });
    
    // ============================================
    // Refresh Data
    // ============================================
    $('#refreshDataBtn').on('click', function() {
        if (gridApi) {
            gridApi.destroy();
            gridApi = null;
        }
        loadExperimentData();
    });
    
    // ============================================
    // UI State Management
    // ============================================
    function showLoading() {
        $('#loadingSpinner').removeClass('hidden');
        $('#dataGridContainer').addClass('hidden');
        $('#errorMessage').addClass('hidden');
    }
    
    function showDataGrid() {
        $('#loadingSpinner').addClass('hidden');
        $('#dataGridContainer').removeClass('hidden');
        $('#errorMessage').addClass('hidden');
    }
    
    function showError(message) {
        $('#loadingSpinner').addClass('hidden');
        $('#dataGridContainer').addClass('hidden');
        $('#errorMessage').removeClass('hidden');
        $('#errorText').text(message);
    }
    
    // ============================================
    // Initialize
    // ============================================
    loadExperimentData();
});
</script>
{% endblock inline_extra_js %}

