{% extends "base_private.html" %}
{% load static %}

{% load countries %}
{% load set_var %}
{% load survey_formats %}
{% load visibility_scopes %}


{% block content %}
<main class="grow">
    <div class="px-4 sm:px-6 lg:px-8 py-8 w-full max-w-9xl mx-auto">

        <!-- Page header -->
        <div class="sm:flex sm:justify-between sm:items-center mb-8">

            <!-- Left: Title -->
            <div class="mb-4 sm:mb-0">
                <h1 class="text-2xl md:text-3xl text-slate-100 font-bold">
                    Create a new Scientific Experiment
                </h1>
            </div>

        </div>

        <!-- Experiment Details -->
        <div class="bg-slate-800 shadow-lg rounded-sm mb-8">
            <div class="flex flex-col md:flex-row md:-mr-px">
                <div class="grow">

                    <form id="new_experiment_form" autocomplete="off">

                        {% csrf_token %}

                        <!-- Panel body -->
                        <div class="p-6 space-y-6">

                            <!-- Experiment Name -->
                            <section>
                                <div class="flex flex-wrap mt-5 gap-4">
                                    <div class="w-full lg:flex-1">
                                        <label class="block text-sm font-medium mb-1" for="latitude">Experiment Name:<span class="text-rose-600"> *</span></label>
                                        <input id="name" name="name" class="form-input max-w-full w-full" type="text" />
                                    </div>
                                    
                                    <div class="w-full lg:flex-1">
                                        <div class="flex flex-wrap gap-4">

                                            <div class="w-full lg:flex-1">
                                                <label class="block text-sm font-medium mb-1" for="code">Experiment Code:</label>
                                                <input id="code" name="code" class="form-input max-w-full w-full" type="text" placeholder="[Optional]" />
                                            </div>

                                            <div class="w-full lg:flex-1">
                                                <label class="block text-sm font-medium mb-1" for="start_date">Start Date</label>
                                                <input type="date" id="start_date" name="start_date" class="form-input max-w-full w-full">
                                            </div>
                                            <div class="w-full lg:flex-1">
                                                <label class="block text-sm font-medium mb-1" for="end_date">End Date</label>
                                                <input type="date" id="end_date" name="end_date" class="form-input max-w-full w-full">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <!-- Description -->
                            <section>
                                <div class="sm:flex sm:items-center space-y-4 sm:space-y-0 sm:space-x-4 mt-5">
                                    <div class="w-full">
                                        <label class="block text-sm font-medium mb-1" for="description">Description:</label>
                                        <textarea id="description" name="description" class="form-textarea  max-w-full w-full focus:border-slate-300" rows="4"></textarea>
                                    </div>
                                </div>
                            </section>

                            <!-- Data Collection Fields -->
                            <section>
                                <div class="mt-5">
                                    <h3 class="text-lg font-semibold text-slate-100 mb-4">Data Collection Fields</h3>
                                    <p class="text-sm text-slate-400 mb-4">Define the fields that will be tracked for each station in this experiment.</p>
                                    
                                    <!-- Mandatory Fields -->
                                    <div class="space-y-3 mb-6">
                                        <h4 class="text-sm font-medium text-slate-300 mb-3">Mandatory Fields (non-editable)</h4>
                                        
                                        <!-- Date Field -->
                                        <div class="bg-slate-700 bg-opacity-50 rounded-lg p-4 border border-slate-600">
                                            <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                                                <div class="flex-1">
                                                    <label class="block text-xs font-medium text-slate-400 mb-1">Field Name</label>
                                                    <input type="text" value="Measurement Date" class="form-input w-full bg-slate-600 opacity-60 cursor-not-allowed" disabled />
                                                </div>
                                                <div class="flex-1">
                                                    <label class="block text-xs font-medium text-slate-400 mb-1">Field Type</label>
                                                    <input type="text" value="Date" class="form-input w-full bg-slate-600 opacity-60 cursor-not-allowed" disabled />
                                                </div>
                                                <div class="flex items-center mt-5 sm:mt-0">
                                                    <label class="flex items-center cursor-not-allowed opacity-60">
                                                        <input type="checkbox" checked disabled class="form-checkbox" />
                                                        <span class="text-sm ml-2 text-slate-400">Required</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Submitter Field -->
                                        <div class="bg-slate-700 bg-opacity-50 rounded-lg p-4 border border-slate-600">
                                            <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                                                <div class="flex-1">
                                                    <label class="block text-xs font-medium text-slate-400 mb-1">Field Name</label>
                                                    <input type="text" value="Submitter Email" class="form-input w-full bg-slate-600 opacity-60 cursor-not-allowed" disabled />
                                                </div>
                                                <div class="flex-1">
                                                    <label class="block text-xs font-medium text-slate-400 mb-1">Field Type</label>
                                                    <input type="text" value="Text" class="form-input w-full bg-slate-600 opacity-60 cursor-not-allowed" disabled />
                                                </div>
                                                <div class="flex items-center mt-5 sm:mt-0">
                                                    <label class="flex items-center cursor-not-allowed opacity-60">
                                                        <input type="checkbox" checked disabled class="form-checkbox" />
                                                        <span class="text-sm ml-2 text-slate-400">Required</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Custom Fields -->
                                    <div>
                                        <div class="flex justify-between items-center mb-3">
                                            <h4 class="text-sm font-medium text-slate-300">Custom Fields</h4>
                                            <button type="button" id="add_field_btn" class="btn-sm bg-indigo-500 hover:bg-indigo-600 text-white">
                                                <svg class="w-4 h-4 fill-current opacity-50 shrink-0 inline-block mr-1" viewBox="0 0 16 16">
                                                    <path d="M15 7H9V1c0-.6-.4-1-1-1S7 .4 7 1v6H1c-.6 0-1 .4-1 1s.4 1 1 1h6v6c0 .6.4 1 1 1s1-.4 1-1V9h6c.6 0 1-.4 1-1s-.4-1-1-1z" />
                                                </svg>
                                                Add Field
                                            </button>
                                        </div>
                                        
                                        <div id="custom_fields_container" class="space-y-3">
                                            <!-- Custom fields will be added here dynamically -->
                                        </div>

                                        <div id="no_fields_message" class="text-center py-8 text-slate-500 border-2 border-dashed border-slate-600 rounded-lg">
                                            No custom fields yet. Click "Add Field" to create one.
                                        </div>
                                    </div>
                                </div>
                            </section>

                        </div>

                        <!-- Panel footer -->
                        <footer>
                            <div class="flex flex-col px-6 py-5 border-t border-slate-200 border-slate-700">
                                <div class="flex self-end">
                                    <a class="btn bg-slate-800 border-slate-700 hover:border-slate-600 text-slate-300" href="{% url 'private:experiments' %}">Cancel</a>
                                    <button id="btn_submit" class="btn bg-indigo-500 hover:bg-indigo-600 text-white ml-3">Save Changes</button>
                                </div>
                            </div>
                        </footer>

                    </form>

                    {% include 'snippets/modal_success.html' %}
                    {% include 'snippets/modal_error.html' %}

                </div>
            </div>
        </div>
    </div>
</main>
{% endblock content %}

{% block extra_js %}
<script src="{% url 'url_reverse.js' %}"></script>
<script src="{% static 'private/js/experiment-fields.js' %}"></script>
{% endblock extra_js %}

{% block inline_extra_js %}
<script>
    $(window).on('load', function() {
        // Initialize common experiment fields functionality
        ExperimentFields.initialize();

        // Collect custom fields data (new.html specific)
        // Note: Slug generation and hashing are done server-side by the serializer
        // Mandatory fields are identified by their slug, not a 'mandatory' property
        function collectCustomFields() {
            const fields = [];
            
            // Add mandatory fields (server will generate slugs and hashes)
            // These correspond to MandatoryFieldSlug enum values
            fields.push({
                name: 'Measurement Date',
                type: 'date',
                required: true
            });
            
            fields.push({
                name: 'Submitter Email',
                type: 'text',
                required: true
            });
            
            // Add custom fields
            $('.field-item').each(function() {
                const fieldName = $(this).find('.field-name').val().trim();
                const fieldType = $(this).find('.field-type').val();
                const fieldRequired = $(this).find('.field-required').is(':checked');
                
                if (fieldName) {
                    const fieldData = {
                        name: ExperimentFields.toTitleCase(fieldName),
                        type: fieldType,
                        required: fieldRequired
                    };
                    
                    // If field type is select, collect options from tags
                    if (fieldType === 'select') {
                        const options = [];
                        $(this).find('.field-tags-container .tag-text').each(function() {
                            options.push($(this).text());
                        });
                        fieldData.options = options;
                    }
                    
                    fields.push(fieldData);
                }
            });
            
            return fields;
        }

        // Form submission handler
        $('#btn_submit').click(function (e) {
            e.preventDefault();

            $("#error_div").hide();
            $("#success_div").hide();

            // Validate unique field names
            if (!ExperimentFields.validateUniqueFieldNames()) {
                $("#modal_error_txt").html("Duplicate field names detected. Each field must have a unique name. Please check the highlighted fields.");
                $("#modal_error").css('display', 'flex');
                return false;
            }

            // Validate that at least custom fields exist
            const customFields = collectCustomFields();
            if (customFields.length === 2) { // Only mandatory fields
                $("#modal_error_txt").html("Please add at least one custom field for data collection.");
                $("#modal_error").css('display', 'flex');
                return false;
            }

            var csrftoken = $('input[name^=csrfmiddlewaretoken]').val();
            let new_experiment_form = document.getElementById('new_experiment_form');
            var formData = new FormData(new_experiment_form);
            
            // Convert to object and add custom fields
            // Note: Backend serializer will generate slugs and hashes
            var dataObject = Object.fromEntries(formData);
            dataObject.experiment_fields = customFields;

            $.ajax({
                url: "{% url 'api:v1:experiments' %}",
                method: "POST",
                data: JSON.stringify(dataObject),
                contentType: "application/json; charset=utf-8",
                cache: false,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    return true;
                },
                success: function (data) {
                    $("#modal_success_txt").html("The experiment has been created.");
                    $("#modal_success").css('display', 'flex');

                    window.setTimeout(function(){
                        window.location.href = Urls['private:experiment_details'](data["data"]["id"]);
                    }, 2000);
                },
                error: function (data) {
                    {% include 'snippets/ajax_error_modal_management.js' %}
                }
            });
            return false; // prevent default
        });
    });
</script>
{% endblock inline_extra_js %}
