{% extends "base_private.html" %}
{% load static %}

{% block content %}
<main class="grow">
    <div class="px-4 sm:px-6 lg:px-8 py-8 w-full max-w-9xl mx-auto">

        <!-- Page header -->
        <div class="sm:flex sm:justify-between sm:items-center mb-8">

            <!-- Left: Title -->
            <div class="mb-4 sm:mb-0">
                <h1 class="text-2xl md:text-3xl text-slate-100 font-bold">
                    Create a new Sensor Fleet
                </h1>
            </div>

        </div>

        <!-- Sensor Fleet Details -->
        <div class="bg-slate-800 shadow-lg rounded-sm mb-8">
            <div class="flex flex-col md:flex-row md:-mr-px">
                <div class="grow">

                    <form id="new_sensor_fleet_form" autocomplete="off">

                        {% csrf_token %}

                        <!-- Panel body -->
                        <div class="p-6 space-y-6">

                            <!-- Fleet Name & Description -->
                            <section>
                                <h2 class="text-xl text-slate-100 font-bold mb-4">Fleet Information</h2>
                                
                                <div class="flex flex-wrap mt-5 gap-4">
                                    <div class="w-full lg:flex-1">
                                        <label class="block text-sm font-medium mb-1" for="name">Fleet Name:<span class="text-rose-600"> *</span></label>
                                        <input id="name" name="name" class="form-input max-w-full w-full" type="text" placeholder="e.g., Flow Meters - Yucatan Peninsula" />
                                    </div>
                                </div>

                                <div class="sm:flex sm:items-center space-y-4 sm:space-y-0 sm:space-x-4 mt-5">
                                    <div class="w-full">
                                        <label class="block text-sm font-medium mb-1" for="description">Description:</label>
                                        <textarea id="description" name="description" class="form-textarea max-w-full w-full focus:border-slate-300" rows="4" placeholder="Optional description of the sensor fleet"></textarea>
                                    </div>
                                </div>
                            </section>

                            <!-- Initial Sensors (Optional) -->
                            <section>
                                <div class="mt-8">
                                    <h3 class="text-lg font-semibold text-slate-100 mb-2">Initial Sensors (Optional)</h3>
                                    <p class="text-sm text-slate-400 mb-4">You can add sensors now or after creating the fleet.</p>
                                    
                                    <!-- Sensors Container -->
                                    <div id="sensors_container" class="space-y-3 mb-4">
                                        <!-- Dynamic sensors will be added here -->
                                    </div>

                                    <!-- Add Sensor Button -->
                                    <button type="button" id="add_sensor_btn" class="btn-sm bg-indigo-500 hover:bg-indigo-600 text-white">
                                        <svg class="w-4 h-4 fill-current opacity-50 shrink-0 inline-block mr-1" viewBox="0 0 16 16">
                                            <path d="M15 7H9V1c0-.6-.4-1-1-1S7 .4 7 1v6H1c-.6 0-1 .4-1 1s.4 1 1 1h6v6c0 .6.4 1 1 1s1-.4 1-1V9h6c.6 0 1-.4 1-1s-.4-1-1-1z" />
                                        </svg>
                                        Add Sensor
                                    </button>
                                </div>
                            </section>

                        </div>

                        <!-- Panel footer -->
                        <footer>
                            <div class="flex flex-col px-6 py-5 border-t border-slate-200 border-slate-700">
                                <div class="flex self-end">
                                    <a class="btn bg-slate-800 border-slate-700 hover:border-slate-600 text-slate-300" href="{% url 'private:sensor_fleets' %}">Cancel</a>
                                    <button id="btn_submit" class="btn bg-indigo-500 hover:bg-indigo-600 text-white ml-3">Create Fleet</button>
                                </div>
                            </div>
                        </footer>

                    </form>

                    {% include 'snippets/modal_success.html' %}
                    {% include 'snippets/modal_error.html' %}

                </div>
            </div>
        </div>
    </div>
</main>
{% endblock content %}

{% block extra_js %}
<script src="{% url 'url_reverse.js' %}"></script>
{% endblock extra_js %}

{% block inline_extra_js %}
<script>
    $(window).on('load', function() {
        let sensorIdCounter = 0;

        // Add sensor functionality
        $('#add_sensor_btn').click(function() {
            sensorIdCounter++;
            const sensorHtml = `
                <div class="bg-slate-700 bg-opacity-50 rounded-lg p-4 border border-slate-600 sensor-item" data-sensor-id="${sensorIdCounter}">
                    <div class="flex flex-col sm:flex-row sm:items-start gap-3">
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-slate-400 mb-1">Sensor Name <span class="text-rose-600">*</span></label>
                            <input type="text" class="sensor-name form-input w-full" placeholder="e.g., Flow Meter #023" />
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-slate-400 mb-1">Notes</label>
                            <textarea class="sensor-notes form-textarea w-full" rows="2" placeholder="Optional notes"></textarea>
                        </div>
                        <div class="flex flex-col gap-2 mt-5 sm:mt-0">
                            <button type="button" class="remove-sensor-btn btn-sm bg-rose-500 hover:bg-rose-600 text-white">
                                <svg class="w-3 h-3 fill-current inline-block" viewBox="0 0 16 16">
                                    <path d="M5 7h6a1 1 0 010 2H5a1 1 0 010-2z" />
                                </svg>
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
            `;
            $('#sensors_container').append(sensorHtml);
        });

        // Remove sensor functionality
        $(document).on('click', '.remove-sensor-btn', function() {
            $(this).closest('.sensor-item').remove();
        });

        // Collect sensors data
        function collectSensors() {
            const sensors = [];
            $('.sensor-item').each(function() {
                const name = $(this).find('.sensor-name').val().trim();
                const notes = $(this).find('.sensor-notes').val().trim();
                
                if (name) { // Only add if name is provided
                    sensors.push({
                        name: name,
                        notes: notes,
                    });
                }
            });
            return sensors;
        }

        // Form submission handler
        $('#btn_submit').click(function (e) {
            e.preventDefault();

            $("#error_div").hide();
            $("#success_div").hide();

            // Get form data
            const name = $('#name').val().trim();
            const description = $('#description').val().trim();
            const isActive = $('#is_active').is(':checked');

            // Validation
            if (!name) {
                $("#modal_error_txt").html("Fleet name is required.");
                $("#modal_error").css('display', 'flex');
                return false;
            }

            // Collect sensors
            const sensors = collectSensors();

            // Prepare data object
            const dataObject = {
                name: name,
                description: description
            };

            // Add sensors if any
            if (sensors.length > 0) {
                dataObject.sensors = sensors;
            }

            console.log('üöÄ Creating sensor fleet:', dataObject);

            // Get CSRF token
            const csrftoken = $('[name=csrfmiddlewaretoken]').val();

            // REAL API CALL
            $.ajax({
                url: "{% url 'api:v1:sensor-fleets' %}",
                method: 'POST',
                data: JSON.stringify(dataObject),
                contentType: 'application/json; charset=utf-8',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                success: function(response) {
                    console.log('‚úÖ Fleet created successfully:', response);
                    
                    $("#modal_success_txt").html("The sensor fleet has been created successfully.");
                    $("#modal_success").css('display', 'flex');

                    window.setTimeout(function(){
                        // Redirect to fleet details page
                        window.location.href = Urls['private:sensor_fleet_details'](response.data.id);
                    }, 2000);
                },
                error: function(xhr) {
                    console.error('‚ùå Error creating fleet:', xhr);
                    
                    const response = xhr.responseJSON || {};
                    let errorMsg = 'Failed to create sensor fleet.';
                    
                    // Extract specific error message
                    if (response.errors) {
                        if (response.errors.name) {
                            errorMsg = response.errors.name[0];
                        } else if (response.errors.sensors) {
                            errorMsg = response.errors.sensors[0];
                        } else if (response.errors.non_field_errors) {
                            errorMsg = response.errors.non_field_errors[0];
                        } else {
                            // Get first error from any field
                            const firstError = Object.values(response.errors)[0];
                            errorMsg = Array.isArray(firstError) ? firstError[0] : firstError;
                        }
                    } else if (response.error) {
                        errorMsg = response.error;
                    }
                    
                    $("#modal_error_txt").html(errorMsg);
                    $("#modal_error").css('display', 'flex');
                }
            });

            return false; // prevent default
        });

        // Close modal handlers
        $('#modal_error button, #modal_success button').click(function() {
            $(this).closest('.fixed').fadeOut(200);
        });
    });

</script>
{% endblock inline_extra_js %}
