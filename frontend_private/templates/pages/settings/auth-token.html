{% extends "pages/settings/base.html" %}
{% load static i18n compress%}

{% load countries %}

{% block right_panel %}
<!-- Panel -->
<div class="grow">

    <!-- Panel body -->
    <div class="p-6">
        <h2 class="text-2xl text-slate-800 text-slate-100 font-bold mb-5">Application Token</h2>

        <!-- Full Name -->
        <section>
            <div class="sm:flex sm:items-center space-y-4 sm:space-y-0 sm:space-x-4 mt-5">
                <div class="w-full">
                    <label class="block text-sm font-medium mb-1" for="name">Current Application Token:</label>
                    <input class="form-input max-w-full w-128" type="text" value="{{ auth_token.key }}" disabled/>
                </div>
            </div>
        </section>

        <div class="flex flex-col px-6 py-5 border-t border-slate-200 border-slate-700 mt-16">
            <div class="text-right">
                <h2 class="mb-6">
                    If you believe your token has been compromised, you can generate a new one.<br>
                    Treat this value just like you would treat your password.</h2>
                <form action="{% url 'private:auth-token' %}" method="POST">
                    {% csrf_token %}
                    <button class="btn bg-rose-500 hover:bg-rose-600 text-white ml-3">Refresh Token</button>
                </form>
            </div>
        </div>

    </div>

    {% include 'snippets/modal_success.html' %}
    {% include 'snippets/modal_error.html' %}

</div>
{% endblock right_panel %}


{% block inline_extra_js %}
{% comment %} <script>

    $(document).ready(function () {

        $("body").click(function() {
            if ($("#modal_success").is(":visible")) {
                $("#modal_success").hide();
            }
            if ($("#modal_error").is(":visible")) {
                $("#modal_error").hide();
            }
        });

        function validateEmail(email) {
            var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(email);
        }

        $('#btn_submit_password_form').click(function () {
            var csrftoken = $('input[name^=csrfmiddlewaretoken]').val();
            let change_password_form = document.getElementById('change_password_form');
            var formData = new FormData(change_password_form);

            $("#error_div").hide();
            $("#success_div").hide();

            $.ajax({
                url: "{% url 'api:v1_users:change_user_password' %}",
                method: "PUT",
                data: JSON.stringify(Object.fromEntries(formData)),
                contentType: "application/json; charset=utf-8",
                cache: false,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);

                    if ($("#oldpassword").val() == ""){
                        $("#modal_error_txt").text("The `oldpassword` field is empty !");
                        $("#modal_error").css('display', 'flex');
                        return false;
                    }

                    if ($("#password1").val() == "" || $("#password2").val() == ""){
                        $("#modal_error_txt").text("One of the `password` fields is empty !");
                        $("#modal_error").css('display', 'flex');
                        return false;
                    }

                    if ($("#password1").val() != $("#password2").val()){
                        $("#modal_error_txt").text("Password fields do not match !");
                        $("#modal_error").css('display', 'flex');
                        return false;
                    }

                    return true;

                },
                success: function (data) {
                    $("#modal_success_txt").html(
                        "Success your password was updated.<br>" +
                        "You will now need to re-authenticate."
                    );
                    $("#modal_success").css('display', 'flex');
                    window.setTimeout(function(){
                        // Redirect the user to login page
                        window.location.href = "{% url 'account_login' %}";
                    }, 2000);
                },
                error: function (data) {
                  if (data.status == 429) {
                    $("#modal_error_txt").text(data.responseJSON["detail"]);
                    $("#modal_error").css('display', 'flex');
                  }
                  else {
                    $("#modal_error_txt").text(data.responseJSON["errors"][0]);
                    $("#modal_error").css('display', 'flex');
                  }
                }
            });
            return false; // prevent default
        });

    });
</script> {% endcomment %}
{% endblock inline_extra_js %}